<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PCR EXTRAHOSPITAL√ÄRIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; touch-action: pan-y; -webkit-user-select: none; overflow-y: auto; }
        .btn-press:active { transform: scale(0.95); filter: brightness(0.9); }
        .log-entry { animation: slideIn 0.3s ease-out; position: relative; overflow: hidden; min-height: 50px; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Swipe optimitzat per no bloquejar l'scroll vertical */
        .swipe-container { display: flex; transition: transform 0.3s ease; width: calc(100% + 80px); touch-action: pan-y; }
        .swipe-content { width: calc(100% - 80px); display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1.25rem; background: white; border-bottom: 1px solid #f1f5f9; }
        .delete-btn { width: 80px; background: #ef4444; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; text-transform: uppercase; cursor: pointer; }
        .swiped { transform: translateX(-80px); }

        .alert-flash { animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { background-color: #fee2e2; } 50% { background-color: #ef4444; color: white; } }
        .adr-flash { animation: flash-orange 1s infinite; }
        @keyframes flash-orange { 0%, 100% { background-color: #ffedd5; } 50% { background-color: #f97316; color: white; } }
        
        .selected-item { background-color: #64748b !important; color: white !important; border-color: #475569 !important; }
        
        #toast { transition: opacity 0.5s ease; pointer-events: none; }
        /* Amagar scrollbar per√≤ permetre scroll */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col text-slate-800">

    <div id="toast" class="opacity-0 fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[200] bg-red-600 text-white px-8 py-4 rounded-3xl shadow-2xl text-center">
        <p id="toast-title" class="text-xs font-bold uppercase mb-1">Atenci√≥</p>
        <p id="toast-msg" class="text-2xl font-black uppercase">Revisar Ritme</p>
    </div>

    <header class="sticky top-0 z-50 bg-white px-4 pt-12 pb-4 border-b flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-2 max-w-[70%]">
            <div class="bg-blue-600 p-1.5 rounded-lg text-white font-bold text-sm shrink-0">PCR</div>
            <h1 class="text-base font-black tracking-tighter uppercase leading-none">Extrahospital√†ria</h1>
        </div>
        <button onclick="confirmStop()" class="text-white font-bold text-[9px] bg-red-600 px-3 py-2 rounded-full shadow-sm uppercase shrink-0">Finalitzar</button>
    </header>

    <div id="timer-box" class="sticky top-[84px] z-40 bg-white grid grid-cols-3 border-b divide-x text-center shrink-0">
        <div class="p-3">
            <p class="text-[8px] font-bold text-slate-400 uppercase mb-1">Temps Total</p>
            <span id="t-total" class="text-2xl font-mono font-black tracking-tighter">00:00:00</span>
        </div>
        <div id="cycle-box" class="p-3">
            <p class="text-[8px] font-bold text-slate-400 uppercase mb-1">Ritme en:</p>
            <span id="t-cycle" class="text-2xl font-mono font-black text-blue-600 tracking-tighter">02:00</span>
        </div>
        <div class="p-3 flex flex-col justify-center items-center">
            <div id="adr-container" class="hidden text-center cursor-pointer" onclick="toggleAdrLimit()">
                <p class="text-[7px] font-bold text-orange-500 uppercase">Adrenalina (<span id="adr-limit-val">3</span>')</p>
                <span id="t-adr" class="text-lg font-mono font-black text-orange-600">03:00</span>
            </div>
            <div id="cycle-count-container">
                <p class="text-[8px] font-bold text-slate-400 uppercase mb-1">Cicles</p>
                <span id="cycle-count" class="text-2xl font-mono font-black">1</span>
            </div>
        </div>
    </div>

    <div class="bg-slate-50 px-5 py-2 border-b flex justify-between text-[9px] font-bold text-slate-400 uppercase tracking-widest shrink-0">
        <span class="w-20">Temps</span>
        <span class="flex-1 px-2 text-center">Acci√≥</span>
        <span class="w-16 text-right">Esborrar</span>
    </div>

    <div id="event-log" class="flex-1 bg-white min-h-[200px]">
        <div id="placeholder" class="text-center py-20 opacity-20 italic text-sm">Inicia l'acci√≥ per comen√ßar</div>
    </div>

    <div class="sticky bottom-0 z-50 bg-white border-t shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <div class="bg-slate-50 px-5 py-2 border-b flex items-center justify-between">
            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Recompte:</span>
            <div class="flex gap-4 text-slate-500 font-bold text-[11px]">
                <span>‚è±Ô∏è <span id="count-cicles">1</span></span>
                <span>‚ö° <span id="count-shock">0</span></span>
                <span>üíâ <span id="count-adr">0</span></span>
                <span>üíä <span id="count-amio">0</span></span>
            </div>
        </div>

        <div class="p-4 grid grid-cols-2 gap-2 pb-8">
            <button onclick="toggleModal('ritme-modal')" class="bg-blue-700 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase shadow-md">Ritmes</button>
            <button onclick="logAdrenalina()" class="bg-blue-700 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase shadow-md">Adrenalina</button>
            <button onclick="logAction('Desc√†rrega', '200J', 'shock')" class="bg-blue-700 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase shadow-md">Desc√†rrega</button>
            <button onclick="logAction('Amiodarona', '300 mg', 'amio')" class="bg-blue-700 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase shadow-md">Amiodarona</button>
            <button onclick="toggleModal('intubacio-modal')" class="bg-blue-100 text-blue-800 p-4 rounded-xl font-bold text-[11px] btn-press uppercase">V√≠a A√®ria</button>
            <button onclick="toggleModal('sri-modal')" class="bg-blue-100 text-blue-800 p-4 rounded-xl font-bold text-[11px] btn-press uppercase">SRI (F√†rmacs)</button>
            <button onclick="toggleModal('ht-modal')" class="bg-slate-100 text-slate-700 p-4 rounded-xl font-bold text-[11px] btn-press uppercase border border-slate-200">H/T Causes</button>
            <button onclick="toggleModal('notes-modal')" class="bg-slate-100 text-slate-700 p-4 rounded-xl font-bold text-[11px] btn-press uppercase border border-slate-200">Notes</button>
            <button onclick="toggleModal('history-modal')" class="bg-slate-800 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase col-span-2 text-center shadow-lg">Consultar Historial</button>
        </div>
    </div>

    <script>
        let totalSecs = 0, cycleSecs = 120, cycles = 1, timer, active = false;
        let counts = { shock:0, adr:0, amio:0 };
        let sessionLog = [];
        let audioCtx = null;
        let adrActive = false;
        let adrLimitSecs = 180, adrTimeLeft = 180;
        let selectedBuffer = [];

        // --- L√íGICA DE SWIPE REPARADA PER NO BLOQUEJAR SCROLL ---
        let startX = 0;
        let startY = 0;
        let isMoving = false;

        function handleTouchStart(e) {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            isMoving = true;
        }

        function handleTouchMove(e, id) {
            if (!isMoving) return;
            let moveX = e.touches[0].clientX;
            let moveY = e.touches[0].clientY;
            let diffX = startX - moveX;
            let diffY = Math.abs(startY - moveY);

            // Si el moviment vertical √©s superior a l'horitzontal, ignorem el swipe (√©s scroll)
            if (diffY > Math.abs(diffX)) {
                isMoving = false;
                return;
            }

            let container = document.getElementById('swipe-' + id);
            if (diffX > 40) {
                container.classList.add('swiped');
                isMoving = false;
            } else if (diffX < -40) {
                container.classList.remove('swiped');
                isMoving = false;
            }
        }

        // --- FUNCIONS CORE ---
        function logAction(action, qty = '-', countType = null) {
            if(!active) startCPR();
            const id = Date.now() + Math.random();
            const time = document.getElementById('t-total').innerText;
            if (countType && countType !== 'adr') updateCount(countType, 1); 
            sessionLog.push({ id, time, action, qty, countType });
            renderLog();
        }

        function renderLog() {
            const logDiv = document.getElementById('event-log');
            if(sessionLog.length > 0 && document.getElementById('placeholder')) document.getElementById('placeholder').remove();
            
            logDiv.innerHTML = sessionLog.map(e => `
                <div class="log-entry" ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event, ${e.id})">
                    <div class="swipe-container" id="swipe-${e.id}">
                        <div class="swipe-content">
                            <span class="w-20 text-slate-400 font-mono text-[10px]">${e.time}</span>
                            <span class="flex-1 px-2 uppercase text-center tracking-tight font-bold text-[11px]">${e.action}</span>
                            <span class="w-16 text-right font-bold text-[11px]">${e.qty}</span>
                        </div>
                        <div class="delete-btn" onclick="deleteEntry(${e.id})">Borrar</div>
                    </div>
                </div>`).reverse().join('');
        }

        function deleteEntry(id) {
            const index = sessionLog.findIndex(e => e.id === id);
            if (index !== -1) {
                const entry = sessionLog[index];
                if (entry.countType) updateCount(entry.countType, -1);
                sessionLog.splice(index, 1);
                renderLog();
            }
        }

        function updateCount(k, val) {
            counts[k] += val;
            if (counts[k] < 0) counts[k] = 0;
            document.getElementById('count-'+k).innerText = counts[k];
        }

        // Resta de funcions (startCPR, updateUI, showToast, modals...) se mantenen igual...
        function startCPR() {
            if(active) return; active = true;
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            timer = setInterval(() => {
                totalSecs++; cycleSecs--;
                if(adrActive) adrTimeLeft--;
                if(cycleSecs <= 0) { showToast("REVISAR RITME", "red"); cycleSecs = 120; cycles++; document.getElementById('cycle-count').innerText = cycles; document.getElementById('count-cicles').innerText = cycles; logAction(`CICLE ${cycles} INICIAT`); }
                if(adrActive && adrTimeLeft <= 0) { showToast("ADRENALINA", "orange"); adrTimeLeft = adrLimitSecs; }
                updateUI();
            }, 1000);
        }

        function updateUI() {
            const pad = (n) => n.toString().padStart(2,'0');
            document.getElementById('t-total').innerText = `${pad(Math.floor(totalSecs/3600))}:${pad(Math.floor((totalSecs%3600)/60))}:${pad(totalSecs%60)}`;
            document.getElementById('t-cycle').innerText = `${pad(Math.floor(cycleSecs/60))}:${pad(cycleSecs%60)}`;
            if(adrActive) document.getElementById('t-adr').innerText = `${pad(Math.floor(adrTimeLeft/60))}:${pad(adrTimeLeft%60)}`;
            const cb = document.getElementById('cycle-box');
            if(cycleSecs < 10) cb.classList.add('alert-flash'); else cb.classList.remove('alert-flash');
        }

        function toggleAdrLimit() { adrLimitSecs = (adrLimitSecs === 180) ? 120 : 180; document.getElementById('adr-limit-val').innerText = adrLimitSecs/60; adrTimeLeft = adrLimitSecs; updateUI(); }
        function logAdrenalina() { logAction('Adrenalina', '1 mg', 'adr'); if (!adrActive) { adrActive = true; document.getElementById('adr-container').classList.remove('hidden'); document.getElementById('cycle-count-container').classList.add('hidden'); } adrTimeLeft = adrLimitSecs; }
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); if(id === 'history-modal') loadHistory(); }
        function confirmStop() { if(!active) return; clearInterval(timer); document.getElementById('stop-modal').classList.remove('hidden'); }
        function resumeCPR() { document.getElementById('stop-modal').classList.add('hidden'); active = false; startCPR(); }
        function saveAndReset() { location.reload(); }
        
        // Inicialitzaci√≥ din√†mica de botons de tubs
        window.onload = function() {
            const tContainer = document.getElementById('tube-btns');
            [5.0, 5.5, 6.0, 6.5, 7.0, 7.5, 8.0, 8.5].forEach(m => {
                const b = document.createElement('button');
                b.className = "bg-slate-100 py-2 rounded-lg text-[10px] font-bold border border-transparent transition-colors";
                b.innerText = m;
                b.onclick = function() { toggleSelect(this, 'Tubo ET', m); };
                tContainer.appendChild(b);
            });
        };

        function toggleSelect(btn, action, qty) { btn.classList.toggle('selected-item'); const index = selectedBuffer.findIndex(i => i.action === action && i.qty === qty); if (index > -1) selectedBuffer.splice(index, 1); else selectedBuffer.push({ action, qty }); }
        function confirmMultiple(modalId, containerId) { if (selectedBuffer.length > 0) { selectedBuffer.forEach(item => logAction(item.action, item.qty)); } closeAndClear(modalId, containerId); }
        function closeAndClear(modalId, containerId) { selectedBuffer = []; const buttons = document.querySelectorAll(`#${containerId} button`); buttons.forEach(b => b.classList.remove('selected-item')); toggleModal(modalId); }
        function showToast(msg, type) { /* l√≤gica d'√†udio... */ }
    </script>
</body>
</html>
