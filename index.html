<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PCR PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; touch-action: manipulation; -webkit-user-select: none; }
        .btn-press:active { transform: scale(0.95); filter: brightness(0.9); }
        .log-entry { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .alert-flash { animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { background-color: #fee2e2; } 50% { background-color: #ef4444; color: white; } }
        .cause-selected { background-color: #64748b !important; color: white !important; }
        #toast { transition: opacity 0.5s ease; pointer-events: none; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col overflow-hidden relative">

    <div id="toast" class="opacity-0 fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[100] bg-red-600 text-white px-8 py-4 rounded-3xl shadow-2xl text-center">
        <p class="text-xs font-bold uppercase mb-1">Atenci√≥</p>
        <p class="text-2xl font-black uppercase">Revisar Ritme</p>
    </div>

    <header class="bg-white px-5 pt-12 pb-4 border-b flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 p-1.5 rounded-lg text-white font-bold text-lg w-8 text-center">PCR</div>
            <h1 class="text-xl font-black text-slate-800 tracking-tight uppercase">EXTRAHOSPITALARIA</h1>
        </div>
        <button onclick="confirmStop()" class="text-white font-bold text-[10px] bg-red-600 px-4 py-2 rounded-full shadow-sm uppercase">Finalitzar registre</button>
    </header>

    <div id="timer-box" class="bg-white grid grid-cols-3 border-b divide-x">
        <div class="p-3 text-center">
            <p class="text-[8px] font-bold text-slate-400 uppercase mb-1">Temps Total</p>
            <span id="t-total" class="text-2xl font-mono font-black text-slate-800 tracking-tighter">00:00:00</span>
        </div>
        <div id="cycle-box" class="p-3 text-center">
            <p class="text-[8px] font-bold text-slate-400 uppercase mb-1">Revisi√≥ en:</p>
            <span id="t-cycle" class="text-2xl font-mono font-black text-blue-600 tracking-tighter">02:00</span>
        </div>
        <div class="p-3 text-center">
            <p class="text-[8px] font-bold text-slate-400 uppercase mb-1">Cicle Actual</p>
            <span id="cycle-count" class="text-2xl font-mono font-black text-slate-800">1</span>
        </div>
    </div>

    <div class="bg-slate-50 px-5 py-2 border-b flex justify-between text-[9px] font-bold text-slate-400 uppercase tracking-widest">
        <span class="w-20">Temps</span>
        <span class="flex-1 px-2 text-center">Valoraci√≥ / Acci√≥</span>
        <span class="w-16 text-right">Quant.</span>
    </div>

    <div id="event-log" class="flex-1 overflow-y-auto p-4 space-y-1 flex flex-col-reverse justify-end bg-white">
        <div id="placeholder" class="text-center py-10 opacity-20 italic text-sm">Inicia l'acci√≥ per comen√ßar</div>
    </div>

    <div class="bg-slate-50 px-5 py-2 border-t border-b flex items-center justify-between">
        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Recompte:</span>
        <div class="flex gap-4 text-slate-500 font-bold text-[11px]">
            <span>‚è±Ô∏è <span id="count-cicles">1</span></span>
            <span>‚ö° <span id="count-shock">0</span></span>
            <span>üíâ <span id="count-adr">0</span></span>
            <span>üíä <span id="count-amio">0</span></span>
        </div>
    </div>

    <div class="bg-white p-4 grid grid-cols-2 gap-2 pb-10 shadow-2xl">
        <button onclick="toggleModal('ritme-modal')" class="bg-blue-700 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase">Ritmes</button>
        <button onclick="logAction('Adrenalina', '1 mg'); updateCount('adr')" class="bg-blue-700 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase">Adrenalina</button>
        <button onclick="logAction('Desc√†rrega', '200J'); updateCount('shock')" class="bg-blue-700 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase">Desc√†rrega</button>
        <button onclick="logAction('Amiodarona', '300 mg'); updateCount('amio')" class="bg-blue-700 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase">Amiodarona</button>
        <button onclick="toggleModal('ht-modal')" class="bg-blue-50 text-blue-700 p-4 rounded-xl font-bold text-[11px] btn-press uppercase border border-blue-100">H/T Causes</button>
        <button onclick="toggleModal('notes-modal')" class="bg-blue-50 text-blue-700 p-4 rounded-xl font-bold text-[11px] btn-press uppercase border border-blue-100">Notes</button>
        <button onclick="toggleModal('history-modal')" class="bg-slate-800 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase col-span-2 text-center">Consultar Historial</button>
    </div>

    <div id="stop-modal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-6 z-[110]">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 text-center shadow-2xl">
            <h2 class="text-lg font-black text-slate-800 mb-2 uppercase">Aturar RCP?</h2>
            <p class="text-slate-500 text-sm mb-6">Vols guardar el registre i comen√ßar de nou?</p>
            <div class="space-y-3">
                <button onclick="saveAndReset()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-bold uppercase shadow-lg">Guardar i Finalitzar</button>
                <button onclick="resumeCPR()" class="w-full bg-slate-100 text-slate-600 py-4 rounded-2xl font-bold uppercase tracking-widest">TORNAR</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 h-3/4 flex flex-col shadow-2xl">
            <h2 class="text-xs font-bold text-slate-800 mb-4 uppercase text-center tracking-widest">Historial de Registres</h2>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-3 mb-4"></div>
            <button onclick="toggleModal('history-modal')" class="w-full bg-blue-700 text-white py-3 rounded-full font-bold text-xs uppercase">Tancar</button>
        </div>
    </div>

    <div id="notes-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h2 class="text-xs font-bold text-slate-800 mb-4 uppercase tracking-tighter">Afegir Nota al registre</h2>
            <textarea id="note-input" rows="4" class="w-full border p-3 rounded-xl mb-4 text-sm" placeholder="Escriu la teva nota aqu√≠..."></textarea>
            <div class="flex gap-2">
                <button onclick="saveNote()" class="flex-1 bg-blue-700 text-white py-3 rounded-full font-bold text-xs uppercase">Guardar</button>
                <button onclick="toggleModal('notes-modal')" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-full font-bold text-xs uppercase">Tancar</button>
            </div>
        </div>
    </div>

    <script>
        let totalSecs = 0, cycleSecs = 120, cycles = 1, timer, active = false;
        let counts = { shock:0, adr:0, amio:0 };
        let sessionLog = [];
        const audio = new (window.AudioContext || window.webkitAudioContext)();

        function logAction(action, qty = '-') {
            if(!active) startCPR();
            const time = document.getElementById('t-total').innerText;
            sessionLog.push({ time, action, qty });
            renderLog();
        }

        function renderLog() {
            const logDiv = document.getElementById('event-log');
            if(document.getElementById('placeholder')) document.getElementById('placeholder').remove();
            logDiv.innerHTML = sessionLog.map(e => `
                <div class="log-entry flex justify-between text-[11px] font-bold text-slate-600 py-1.5 border-b border-slate-50 items-center">
                    <span class="w-20 text-slate-400 font-mono text-[10px]">${e.time}</span>
                    <span class="flex-1 px-2 uppercase text-center tracking-tight">${e.action}</span>
                    <span class="w-16 text-right">${e.qty}</span>
                </div>
            `).reverse().join('');
        }

        function startCPR() {
            if(active) return;
            active = true;
            timer = setInterval(() => {
                totalSecs++; cycleSecs--;
                if(cycleSecs <= 0) {
                    showToast();
                    cycleSecs = 120;
                    cycles++;
                    document.getElementById('cycle-count').innerText = cycles;
                    document.getElementById('count-cicles').innerText = cycles;
                    logAction(`CICLE ${cycles} INICIAT`, '-');
                }
                updateUI();
            }, 1000);
        }

        function updateUI() {
            const pad = (n) => n.toString().padStart(2,'0');
            document.getElementById('t-total').innerText = `${pad(Math.floor(totalSecs/3600))}:${pad(Math.floor((totalSecs%3600)/60))}:${pad(totalSecs%60)}`;
            document.getElementById('t-cycle').innerText = `${pad(Math.floor(cycleSecs/60))}:${pad(cycleSecs%60)}`;
            if(cycleSecs < 10) document.getElementById('cycle-box').classList.add('alert-flash');
            else document.getElementById('cycle-box').classList.remove('alert-flash');
        }

        function showToast() {
            document.getElementById('toast').style.opacity = "1";
            setTimeout(() => document.getElementById('toast').style.opacity = "0", 3000);
            const o = audio.createOscillator(); const g = audio.createGain();
            o.connect(g); g.connect(audio.destination); o.frequency.value = 880;
            o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audio.currentTime + 1); o.stop(audio.currentTime + 1);
        }

        function confirmStop() {
            if(!active) return;
            clearInterval(timer);
            document.getElementById('stop-modal').classList.remove('hidden');
        }

        function resumeCPR() {
            document.getElementById('stop-modal').classList.add('hidden');
            active = false;
            startCPR();
        }

        function saveAndReset() {
            const session = {
                date: new Date().toLocaleString(),
                duration: document.getElementById('t-total').innerText,
                cycles: cycles,
                log: [...sessionLog],
                stats: {...counts}
            };
            let history = JSON.parse(localStorage.getItem('rcp_history') || '[]');
            history.push(session);
            localStorage.setItem('rcp_history', JSON.stringify(history));

            totalSecs = 0; cycleSecs = 120; cycles = 1; active = false;
            counts = { shock:0, adr:0, amio:0 };
            sessionLog = [];

            document.getElementById('t-total').innerText = "00:00:00";
            document.getElementById('t-cycle').innerText = "02:00";
            document.getElementById('cycle-count').innerText = "1";
            document.getElementById('count-cicles').innerText = "1";
            document.getElementById('count-shock').innerText = "0";
            document.getElementById('count-adr').innerText = "0";
            document.getElementById('count-amio').innerText = "0";
            document.getElementById('event-log').innerHTML = '<div id="placeholder" class="text-center py-10 opacity-20 italic text-sm">Inicia l\'acci√≥ per comen√ßar</div>';
            
            document.getElementById('stop-modal').classList.add('hidden');
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('rcp_history') || '[]');
            const list = document.getElementById('history-list');
            list.innerHTML = history.length ? history.map(s => `
                <div class="p-3 bg-slate-50 rounded-xl border text-[10px] shadow-sm mb-2">
                    <div class="flex justify-between font-black text-blue-700 mb-1 uppercase">
                        <span>${s.date}</span>
                        <span>Durada: ${s.duration}</span>
                    </div>
                    <p class="font-bold">Cicles: ${s.cycles} | Shock: ${s.stats.shock} | Adr: ${s.stats.adr} | Amio: ${s.stats.amio}</p>
                    <details class="mt-2 text-slate-500 bg-white p-2 rounded-lg border">
                        <summary class="font-bold cursor-pointer uppercase text-[9px]">Veure registre complet</summary>
                        <div class="mt-2 space-y-1">
                            ${s.log.map(l => `<p class="border-b pb-1"><strong>${l.time}</strong> - ${l.action} ${l.qty !== '-' ? '('+l.qty+')' : ''}</p>`).join('')}
                        </div>
                    </details>
                </div>
            `).reverse().join('') : "<p class='text-center opacity-40 py-4 text-xs font-bold uppercase'>Sense registres.</p>";
        }

        function saveNote() {
            const val = document.getElementById('note-input').value;
            if(val) {
                logAction("NOTA: " + val);
                document.getElementById('note-input').value = '';
                toggleModal('notes-modal');
            }
        }

        function toggleModal(id) {
            document.getElementById(id).classList.toggle('hidden');
            if(id === 'history-modal') loadHistory();
        }

        function logRitme(r) { logAction('Ritme: ' + r); toggleModal('ritme-modal'); }
        function toggleHT(c) { 
            const b = document.getElementById('btn-' + c);
            b.classList.toggle('cause-selected');
            logAction('Causa: ' + c, b.classList.contains('cause-selected') ? 'SI' : 'NO');
        }
        function updateCount(k) { counts[k]++; document.getElementById('count-'+k).innerText = counts[k]; }
    </script>

    <div id="ritme-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 text-center shadow-2xl">
            <h2 class="text-xs font-bold text-slate-800 mb-6 uppercase">Tipus de Ritme</h2>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="logRitme('AESP')" class="bg-slate-500 text-white py-3 rounded-full text-[11px] font-bold btn-press">AESP</button>
                <button onclick="logRitme('Asist√≤lia')" class="bg-slate-500 text-white py-3 rounded-full text-[11px] font-bold btn-press">Asist√≤lia</button>
                <button onclick="logRitme('FV')" class="bg-blue-600 text-white py-3 rounded-full text-[11px] font-bold btn-press">FV</button>
                <button onclick="logRitme('TVsp')" class="bg-blue-600 text-white py-3 rounded-full text-[11px] font-bold btn-press">TVsp</button>
            </div>
            <button onclick="toggleModal('ritme-modal')" class="text-slate-400 font-bold text-xs uppercase">Tancar</button>
        </div>
    </div>

    <div id="ht-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h2 class="text-xs font-bold text-slate-800 mb-6 text-center uppercase">Causes Reversibles</h2>
            <div class="grid grid-cols-2 gap-2">
                <button id="btn-Hipovol√®mia" onclick="toggleHT('Hipovol√®mia')" class="bg-blue-900 text-white py-2 rounded-full text-[10px] font-bold btn-press shadow-md">Hipovol√®mia</button>
                <button id="btn-Hip√≤xia" onclick="toggleHT('Hip√≤xia')" class="bg-blue-900 text-white py-2 rounded-full text-[10px] font-bold btn-press shadow-md">Hip√≤xia</button>
                <button id="btn-T√≤xics" onclick="toggleHT('T√≤xics')" class="bg-blue-900 text-white py-2 rounded-full text-[10px] font-bold btn-press shadow-md">T√≤xics</button>
                <button id="btn-Trombosi" onclick="toggleHT('Trombosi')" class="bg-blue-900 text-white py-2 rounded-full text-[10px] font-bold btn-press shadow-md">Trombosi</button>
            </div>
            <button onclick="toggleModal('ht-modal')" class="w-full mt-4 bg-blue-700 text-white py-3 rounded-full font-bold text-xs uppercase shadow-lg">Acceptar</button>
        </div>
    </div>
</body>
</html>
