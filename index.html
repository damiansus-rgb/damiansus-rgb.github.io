<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PCR EXTRAHOSPITAL√ÄRIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; touch-action: manipulation; -webkit-user-select: none; }
        .btn-press:active { transform: scale(0.95); filter: brightness(0.9); }
        .log-entry { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .alert-flash { animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { background-color: #fee2e2; } 50% { background-color: #ef4444; color: white; } }
        .adr-alert { animation: flash-orange 1s infinite; }
        @keyframes flash-orange { 0%, 100% { background-color: #ffedd5; } 50% { background-color: #f97316; color: white; } }
        .cause-selected { background-color: #64748b !important; color: white !important; }
        #toast { transition: opacity 0.5s ease; pointer-events: none; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col overflow-hidden relative text-slate-800">

    <div id="toast" class="opacity-0 fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[100] bg-red-600 text-white px-8 py-4 rounded-3xl shadow-2xl text-center">
        <p id="toast-title" class="text-xs font-bold uppercase mb-1">Atenci√≥</p>
        <p id="toast-msg" class="text-2xl font-black uppercase">Revisar Ritme</p>
    </div>

    <header class="bg-white px-4 pt-12 pb-4 border-b flex justify-between items-center shadow-sm shrink-0">
        <div class="flex items-center gap-2 max-w-[70%]">
            <div class="bg-blue-600 p-1.5 rounded-lg text-white font-bold text-sm shrink-0">PCR</div>
            <h1 class="text-base font-black tracking-tighter uppercase leading-none">Extrahospital√†ria</h1>
        </div>
        <button onclick="confirmStop()" class="text-white font-bold text-[9px] bg-red-600 px-3 py-2 rounded-full shadow-sm uppercase shrink-0">Finalitzar</button>
    </header>

    <div id="timer-box" class="bg-white grid grid-cols-4 border-b divide-x text-center shrink-0">
        <div class="p-2">
            <p class="text-[7px] font-bold text-slate-400 uppercase mb-1">Temps Total</p>
            <span id="t-total" class="text-xl font-mono font-black tracking-tighter">00:00:00</span>
        </div>
        <div id="adr-box" class="p-2 hidden bg-orange-50 transition-colors" onclick="toggleAdrInterval()">
            <p class="text-[7px] font-bold text-orange-400 uppercase mb-1">Pr√≤xima Adren (<span id="adr-interval-label">3</span>')</p>
            <span id="t-adr" class="text-xl font-mono font-black text-orange-600 tracking-tighter">03:00</span>
        </div>
        <div id="cycle-box" class="p-2">
            <p class="text-[7px] font-bold text-slate-400 uppercase mb-1">Revisi√≥ en:</p>
            <span id="t-cycle" class="text-xl font-mono font-black text-blue-600 tracking-tighter">02:00</span>
        </div>
        <div class="p-2">
            <p class="text-[7px] font-bold text-slate-400 uppercase mb-1">Cicles</p>
            <span id="cycle-count" class="text-xl font-mono font-black">1</span>
        </div>
    </div>

    <div class="bg-slate-50 px-5 py-2 border-b flex justify-between text-[9px] font-bold text-slate-400 uppercase tracking-widest shrink-0">
        <span class="w-20">Temps</span>
        <span class="flex-1 px-2 text-center">Valoraci√≥ / Acci√≥</span>
        <span class="w-16 text-right">Quant.</span>
    </div>

    <div id="event-log" class="flex-1 overflow-y-auto p-4 space-y-1 flex flex-col-reverse justify-end bg-white">
        <div id="placeholder" class="text-center py-10 opacity-20 italic text-sm">Inicia l'acci√≥ per comen√ßar</div>
    </div>

    <div class="bg-slate-50 px-5 py-2 border-t border-b flex items-center justify-between shrink-0">
        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Recompte:</span>
        <div class="flex gap-4 text-slate-500 font-bold text-[11px]">
            <span>‚è±Ô∏è <span id="count-cicles">1</span></span>
            <span>‚ö° <span id="count-shock">0</span></span>
            <span>üíâ <span id="count-adr">0</span></span>
            <span>üíä <span id="count-amio">0</span></span>
        </div>
    </div>

    <div class="bg-white p-4 grid grid-cols-2 gap-2 pb-10 shadow-2xl shrink-0">
        <button onclick="toggleModal('ritme-modal')" class="bg-blue-700 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase shadow-md">Ritmes</button>
        <button onclick="logAdren()" class="bg-blue-700 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase shadow-md">Adrenalina</button>
        <button onclick="logAction('Desc√†rrega', '200J'); updateCount('shock')" class="bg-blue-700 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase shadow-md">Desc√†rrega</button>
        <button onclick="logAction('Amiodarona', '300 mg'); updateCount('amio')" class="bg-blue-700 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase shadow-md">Amiodarona</button>
        <button onclick="toggleModal('intubacio-modal')" class="bg-blue-100 text-blue-800 p-4 rounded-xl font-bold text-[11px] btn-press uppercase">V√≠a A√®ria</button>
        <button onclick="logAction('ECMO', 'Inici')" class="bg-blue-100 text-blue-800 p-4 rounded-xl font-bold text-[11px] btn-press uppercase">ECMO</button>
        <button onclick="toggleModal('ht-modal')" class="bg-slate-100 text-slate-700 p-4 rounded-xl font-bold text-[11px] btn-press uppercase border border-slate-200">H/T Causes</button>
        <button onclick="toggleModal('notes-modal')" class="bg-slate-100 text-slate-700 p-4 rounded-xl font-bold text-[11px] btn-press uppercase border border-slate-200">Notes</button>
        <button onclick="toggleModal('history-modal')" class="bg-slate-800 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase col-span-2 text-center shadow-lg">Consultar Historial</button>
    </div>

    <script>
        let totalSecs = 0, cycleSecs = 120, adrSecs = 180, adrInterval = 180, cycles = 1, timer, active = false;
        let counts = { shock:0, adr:0, amio:0 };
        let sessionLog = [];
        let audioCtx = null;
        let adrActive = false;

        function logAction(action, qty = '-') {
            if(!active) startCPR();
            const time = document.getElementById('t-total').innerText;
            sessionLog.push({ time, action, qty });
            renderLog();
        }

        function logAdren() {
            logAction('Adrenalina', '1 mg');
            updateCount('adr');
            if(!adrActive) {
                adrActive = true;
                document.getElementById('adr-box').classList.remove('hidden');
                document.getElementById('timer-box').classList.replace('grid-cols-3', 'grid-cols-4');
            }
            adrSecs = adrInterval; // Reinicia el comptador d'adrenalina al polsar el bot√≥
        }

        function toggleAdrInterval() {
            adrInterval = (adrInterval === 180) ? 120 : 180;
            document.getElementById('adr-interval-label').innerText = adrInterval / 60;
            if(adrSecs > adrInterval) adrSecs = adrInterval;
            updateUI();
        }

        function startCPR() {
            if(active) return;
            active = true;
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            timer = setInterval(() => {
                totalSecs++; 
                cycleSecs--;
                if(adrActive) adrSecs--;

                if(cycleSecs <= 0) {
                    showToast('REVISAR RITME', 'red');
                    cycleSecs = 120; cycles++;
                    document.getElementById('cycle-count').innerText = cycles;
                    document.getElementById('count-cicles').innerText = cycles;
                }

                if(adrActive && adrSecs <= 0) {
                    showToast('ADMINISTRAR ADRENALINA', 'orange');
                    adrSecs = adrInterval;
                }
                updateUI();
            }, 1000);
        }

        function updateUI() {
            const pad = (n) => Math.abs(n).toString().padStart(2,'0');
            document.getElementById('t-total').innerText = `${pad(Math.floor(totalSecs/3600))}:${pad(Math.floor((totalSecs%3600)/60))}:${pad(totalSecs%60)}`;
            document.getElementById('t-cycle').innerText = `${pad(Math.floor(cycleSecs/60))}:${pad(cycleSecs%60)}`;
            document.getElementById('t-adr').innerText = `${pad(Math.floor(adrSecs/60))}:${pad(adrSecs%60)}`;
            
            // Estils alertes
            const cb = document.getElementById('cycle-box');
            if(cycleSecs < 10) cb.classList.add('alert-flash'); else cb.classList.remove('alert-flash');
            
            const ab = document.getElementById('adr-box');
            if(adrActive && adrSecs < 10) ab.classList.add('adr-alert'); else ab.classList.remove('adr-alert');
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            const tm = document.getElementById('toast-msg');
            tm.innerText = msg;
            t.className = type === 'red' ? 'fixed ... bg-red-600 ...' : 'fixed ... bg-orange-600 ...';
            t.style.opacity = "1";
            setTimeout(() => t.style.opacity = "0", 4000);
            
            // Alarma forta i llarga
            if(type === 'red') {
                playAlarm(660, 0.8, 3); // Alarma revisi√≥ (3 beeps llargs)
            } else {
                playAlarm(880, 0.4, 4); // Alarma Adren (4 beeps aguts)
            }
        }

        function playAlarm(freq, duration, repeats) {
            for(let i=0; i<repeats; i++) {
                setTimeout(() => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain); gain.connect(audioCtx.destination);
                    osc.frequency.value = freq;
                    osc.type = "square";
                    gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
                    osc.start(); osc.stop(audioCtx.currentTime + duration);
                }, i * 600);
            }
        }
        
        // La resta de funcions (modals, renderLog, intubaci√≥) es mantenen igual que la versi√≥ anterior...
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); if(id === 'history-modal') loadHistory(); }
        function logIntub(device, size) { logAction(device, 'Mida: ' + size); toggleModal('intubacio-modal'); }
        function renderLog() {
            const logDiv = document.getElementById('event-log');
            if(document.getElementById('placeholder')) document.getElementById('placeholder').remove();
            logDiv.innerHTML = sessionLog.map(e => `
                <div class="log-entry flex justify-between text-[11px] font-bold text-slate-600 py-1.5 border-b border-slate-50 items-center">
                    <span class="w-20 text-slate-400 font-mono text-[10px]">${e.time}</span>
                    <span class="flex-1 px-2 uppercase text-center tracking-tight">${e.action}</span>
                    <span class="w-16 text-right">${e.qty}</span>
                </div>`).reverse().join('');
        }
        function toggleHT(c) { 
            const b = document.getElementById('btn-' + c); b.classList.toggle('cause-selected');
            logAction('Causa: ' + c, b.classList.contains('cause-selected') ? 'SI' : 'NO');
        }
        function updateCount(k) { counts[k]++; document.getElementById('count-'+k).innerText = counts[k]; }
        function logRitme(r) { logAction('Ritme: ' + r); toggleModal('ritme-modal'); }
        function confirmStop() { if(!active) return; clearInterval(timer); document.getElementById('stop-modal').classList.remove('hidden'); }
        function resumeCPR() { document.getElementById('stop-modal').classList.add('hidden'); active = false; startCPR(); }
        function saveAndReset() { location.reload(); } // Implementaci√≥ simple de reset
    </script>
</body>
</html>