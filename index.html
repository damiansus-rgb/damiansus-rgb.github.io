<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PCR EXTRAHOSPITAL√ÄRIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; overflow: hidden; height: 100vh; background-color: #f1f5f9; }
        .btn-press:active { transform: scale(0.96); filter: brightness(0.9); }
        
        /* Contenidors principals */
        .app-layout { display: flex; flex-direction: column; height: 100vh; }
        .scroll-area { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; background: white; }
        
        /* Swipe logic */
        .log-entry { position: relative; overflow: hidden; border-bottom: 1px solid #f1f5f9; background: white; touch-action: pan-y; }
        .swipe-container { display: flex; transition: transform 0.3s ease; width: calc(100% + 80px); }
        .swipe-content { width: calc(100% - 80px); display: flex; justify-content: space-between; align-items: center; padding: 1rem; }
        .delete-btn { width: 80px; background: #ef4444; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .swiped { transform: translateX(-80px); }

        .alert-flash { animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { background-color: white; } 50% { background-color: #fee2e2; color: #ef4444; } }
        .adr-flash { animation: flash-orange 1s infinite; }
        @keyframes flash-orange { 0%, 100% { background-color: #fff7ed; } 50% { background-color: #ffedd5; } }
        
        .selected-item { background-color: #64748b !important; color: white !important; }
        #toast { transition: opacity 0.5s ease; pointer-events: none; z-index: 1000; }
    </style>
</head>
<body>

    <div id="toast" class="opacity-0 fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-600 text-white px-8 py-4 rounded-3xl shadow-2xl text-center">
        <p id="toast-title" class="text-xs font-bold uppercase mb-1">Atenci√≥</p>
        <p id="toast-msg" class="text-2xl font-black uppercase">Revisar Ritme</p>
    </div>

    <div class="app-layout">
        <header class="bg-white px-4 pt-10 pb-4 border-b shrink-0">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <div class="bg-blue-600 px-2 py-1 rounded text-white font-bold text-sm">PCR</div>
                    <h1 class="text-sm font-black uppercase tracking-tighter">Extrahospital√†ria</h1>
                </div>
                <button onclick="confirmStop()" class="bg-red-600 text-white text-[10px] font-bold px-3 py-1.5 rounded-full uppercase">Finalitzar</button>
            </div>
            
            <div id="timer-box" class="grid grid-cols-3 divide-x border rounded-xl bg-slate-50">
                <div class="p-2 text-center">
                    <p class="text-[7px] font-bold text-slate-400 uppercase">Total</p>
                    <span id="t-total" class="text-lg font-mono font-bold">00:00:00</span>
                </div>
                <div id="cycle-box" class="p-2 text-center">
                    <p class="text-[7px] font-bold text-slate-400 uppercase">Ritme en</p>
                    <span id="t-cycle" class="text-lg font-mono font-bold text-blue-600">02:00</span>
                </div>
                <div class="p-2 text-center relative">
                    <div id="cycle-count-container">
                        <p class="text-[7px] font-bold text-slate-400 uppercase">Cicle</p>
                        <span id="cycle-count" class="text-lg font-mono font-bold">1</span>
                    </div>
                    <div id="adr-container" class="hidden absolute inset-0 bg-orange-50 flex flex-col justify-center items-center cursor-pointer" onclick="toggleAdrLimit()">
                        <p class="text-[7px] font-bold text-orange-600 uppercase">Adren (<span id="adr-limit-val">3</span>')</p>
                        <span id="t-adr" class="text-lg font-mono font-bold text-orange-600">03:00</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="bg-slate-50 px-5 py-1 flex justify-between text-[8px] font-bold text-slate-400 uppercase border-b">
            <span>Temps</span>
            <span>Acci√≥ Realitzada</span>
            <span>Quant.</span>
        </div>
        
        <div id="event-log" class="scroll-area">
            <div id="placeholder" class="text-center py-20 opacity-20 italic text-sm">Inicia l'acci√≥ per comen√ßar</div>
        </div>

        <footer class="bg-white border-t shrink-0 shadow-2xl">
            <div class="bg-slate-50 px-5 py-1.5 border-b flex items-center justify-between">
                <span class="text-[9px] font-bold text-slate-400 uppercase">Recompte:</span>
                <div class="flex gap-4 text-slate-600 font-bold text-[10px]">
                    <span>‚è±Ô∏è <span id="count-cicles">1</span></span>
                    <span>‚ö° <span id="count-shock">0</span></span>
                    <span>üíâ <span id="count-adr">0</span></span>
                    <span>üíä <span id="count-amio">0</span></span>
                </div>
            </div>

            <div class="p-3 grid grid-cols-2 gap-2 pb-6">
                <button onclick="toggleModal('ritme-modal')" class="bg-blue-700 text-white p-3 rounded-xl font-bold text-[10px] btn-press uppercase">Ritmes</button>
                <button onclick="logAdrenalina()" class="bg-blue-700 text-white p-3 rounded-xl font-bold text-[10px] btn-press uppercase">Adrenalina</button>
                <button onclick="logAction('Desc√†rrega', '200J', 'shock')" class="bg-blue-700 text-white p-3 rounded-xl font-bold text-[10px] btn-press uppercase">Desc√†rrega</button>
                <button onclick="logAction('Amiodarona', '300 mg', 'amio')" class="bg-blue-700 text-white p-3 rounded-xl font-bold text-[10px] btn-press uppercase">Amiodarona</button>
                <button onclick="toggleModal('intubacio-modal')" class="bg-blue-100 text-blue-800 p-3 rounded-xl font-bold text-[10px] btn-press uppercase">V√≠a A√®ria</button>
                <button onclick="toggleModal('sri-modal')" class="bg-blue-100 text-blue-800 p-3 rounded-xl font-bold text-[10px] btn-press uppercase">SRI (F√†rmacs)</button>
                <button onclick="toggleModal('ht-modal')" class="bg-slate-100 text-slate-600 p-3 rounded-xl font-bold text-[10px] btn-press uppercase border">H/T Causes</button>
                <button onclick="toggleModal('notes-modal')" class="bg-slate-100 text-slate-600 p-3 rounded-xl font-bold text-[10px] btn-press uppercase border">Notes</button>
                <button onclick="toggleModal('history-modal')" class="bg-slate-800 text-white p-3 rounded-xl font-bold text-[10px] btn-press uppercase col-span-2 shadow-lg">Historial</button>
            </div>
        </footer>
    </div>

    <div id="sri-modal" class="hidden fixed inset-0 bg-black/50 z-[200] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-xs p-5 shadow-2xl" id="sri-options">
            <h2 class="text-xs font-bold mb-4 text-center uppercase">F√†rmacs SRI</h2>
            <div class="space-y-2">
                <button onclick="toggleSelect(this, 'Rocuroni', '1.2 mg/kg')" class="w-full bg-slate-50 p-3 rounded-lg text-[10px] font-bold flex justify-between border"><span>Rocuroni</span> <span>1.2 mg/kg</span></button>
                <button onclick="toggleSelect(this, 'Propofol', '2 mg/kg')" class="w-full bg-slate-50 p-3 rounded-lg text-[10px] font-bold flex justify-between border"><span>Propofol</span> <span>2 mg/kg</span></button>
                <button onclick="toggleSelect(this, 'Ketamina', '2 mg/kg')" class="w-full bg-slate-50 p-3 rounded-lg text-[10px] font-bold flex justify-between border"><span>Ketamina</span> <span>2 mg/kg</span></button>
                <button onclick="toggleSelect(this, 'Midazolam', '0.3 mg/kg')" class="w-full bg-slate-50 p-3 rounded-lg text-[10px] font-bold flex justify-between border"><span>Midazolam</span> <span>0.3 mg/kg</span></button>
                <button onclick="confirmMultiple('sri-modal', 'sri-options')" class="w-full bg-blue-600 text-white py-3 rounded-full font-bold text-xs uppercase mt-4">Acceptar</button>
                <button onclick="closeAndClear('sri-modal', 'sri-options')" class="w-full text-slate-400 font-bold text-[10px] uppercase py-2">Tancar</button>
            </div>
        </div>
    </div>

    <div id="intubacio-modal" class="hidden fixed inset-0 bg-black/50 z-[200] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-xs p-5 shadow-2xl" id="airway-options">
            <h2 class="text-xs font-bold mb-4 text-center uppercase tracking-tighter">Dispositiu V√≠a A√®ria</h2>
            <div class="grid grid-cols-4 gap-2 mb-4" id="tube-btns">
                </div>
            <div class="grid grid-cols-3 gap-2 mb-4">
                <button onclick="toggleSelect(this, 'IGEL', '3')" class="bg-slate-50 py-2 rounded-lg text-[10px] font-bold border">IGEL 3</button>
                <button onclick="toggleSelect(this, 'IGEL', '4')" class="bg-slate-50 py-2 rounded-lg text-[10px] font-bold border">IGEL 4</button>
                <button onclick="toggleSelect(this, 'IGEL', '5')" class="bg-slate-50 py-2 rounded-lg text-[10px] font-bold border">IGEL 5</button>
            </div>
            <button onclick="confirmMultiple('intubacio-modal', 'airway-options')" class="w-full bg-blue-600 text-white py-3 rounded-full font-bold text-xs uppercase">Acceptar</button>
            <button onclick="closeAndClear('intubacio-modal', 'airway-options')" class="w-full text-slate-400 font-bold text-[10px] uppercase py-2">Tancar</button>
        </div>
    </div>

    <div id="ht-modal" class="hidden fixed inset-0 bg-black/50 z-[200] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-xs p-5 shadow-2xl" id="ht-options">
            <h2 class="text-xs font-bold mb-4 text-center uppercase">Causes Reversibles</h2>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button onclick="toggleSelect(this, 'H: Hipovol√®mia', 'SI')" class="bg-slate-50 py-2 rounded-lg text-[9px] font-bold border">Hipovol√®mia</button>
                <button onclick="toggleSelect(this, 'H: Hip√≤xia', 'SI')" class="bg-slate-50 py-2 rounded-lg text-[9px] font-bold border">Hip√≤xia</button>
                <button onclick="toggleSelect(this, 'T: Pneumot√≤rax', 'SI')" class="bg-slate-50 py-2 rounded-lg text-[9px] font-bold border">Pneumot√≤rax</button>
                <button onclick="toggleSelect(this, 'T: Trombosi', 'SI')" class="bg-slate-50 py-2 rounded-lg text-[9px] font-bold border">Trombosi</button>
            </div>
            <button onclick="confirmMultiple('ht-modal', 'ht-options')" class="w-full bg-blue-600 text-white py-3 rounded-full font-bold text-xs uppercase">Acceptar</button>
            <button onclick="closeAndClear('ht-modal', 'ht-options')" class="w-full text-slate-400 font-bold text-[10px] uppercase py-2">Tancar</button>
        </div>
    </div>

    <div id="ritme-modal" class="hidden fixed inset-0 bg-black/50 z-[200] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-xs p-5 text-center shadow-2xl">
            <h2 class="text-xs font-bold mb-4 uppercase">Ritme detectat</h2>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button onclick="logRitme('AESP')" class="bg-slate-500 text-white py-3 rounded-xl font-bold text-[10px]">AESP</button>
                <button onclick="logRitme('Asist√≤lia')" class="bg-slate-500 text-white py-3 rounded-xl font-bold text-[10px]">Asist√≤lia</button>
                <button onclick="logRitme('FV')" class="bg-blue-600 text-white py-3 rounded-xl font-bold text-[10px]">FV</button>
                <button onclick="logRitme('TVsp')" class="bg-blue-600 text-white py-3 rounded-xl font-bold text-[10px]">TVsp</button>
            </div>
            <button onclick="logRitme('ROSC')" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-[10px] mb-2 uppercase">ROSC</button>
            <button onclick="toggleModal('ritme-modal')" class="text-slate-400 text-[10px] font-bold uppercase">Cancel¬∑lar</button>
        </div>
    </div>

    <div id="stop-modal" class="hidden fixed inset-0 bg-slate-900/90 z-[300] flex items-center justify-center p-6">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 text-center">
            <h2 class="text-lg font-black uppercase mb-4 text-red-600">Aturar RCP?</h2>
            <button onclick="saveAndReset()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-bold uppercase shadow-lg mb-3">Guardar i Finalitzar</button>
            <button onclick="toggleModal('stop-modal')" class="w-full bg-slate-100 py-3 rounded-2xl font-bold uppercase text-slate-500">Tornar</button>
        </div>
    </div>

    <div id="notes-modal" class="hidden fixed inset-0 bg-black/50 z-[200] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-xs p-5">
            <h2 class="text-xs font-bold mb-4 uppercase">Nota</h2>
            <textarea id="note-input" class="w-full border p-2 rounded text-sm mb-3" rows="3"></textarea>
            <button onclick="saveNote()" class="w-full bg-blue-600 text-white py-3 rounded-full font-bold text-xs uppercase">Guardar</button>
            <button onclick="toggleModal('notes-modal')" class="w-full text-slate-400 text-[10px] font-bold uppercase py-2">Tancar</button>
        </div>
    </div>

    <div id="history-modal" class="hidden fixed inset-0 bg-black/50 z-[200] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-xs p-5 h-[70vh] flex flex-col">
            <h2 class="text-xs font-bold mb-4 uppercase text-center tracking-widest">Historial</h2>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-3 mb-4"></div>
            <button onclick="toggleModal('history-modal')" class="w-full bg-slate-800 text-white py-3 rounded-full font-bold text-xs uppercase">Tancar</button>
        </div>
    </div>

    <script>
        let totalSecs = 0, cycleSecs = 120, cycles = 1, timer, active = false;
        let adrActive = false, adrLimitSecs = 180, adrTimeLeft = 180;
        let counts = { shock:0, adr:0, amio:0 };
        let sessionLog = [];
        let audioCtx = null;
        let selectedBuffer = [];

        // Inicialitzar botons tubs
        const tContainer = document.getElementById('tube-btns');
        [5.0, 6.0, 7.0, 8.0].forEach(m => {
            const b = document.createElement('button');
            b.className = "bg-slate-50 py-2 rounded-lg text-[10px] font-bold border";
            b.innerText = 'T'+m;
            b.onclick = function() { toggleSelect(this, 'Tubo ET', m); };
            tContainer.appendChild(b);
        });

        // --- CORE FUNCTIONS ---
        function logAction(action, qty = '-', countType = null) {
            if(!active) startCPR();
            const id = Date.now() + Math.random();
            const time = document.getElementById('t-total').innerText;
            if (countType && countType !== 'adr') updateCount(countType, 1);
            sessionLog.push({ id, time, action, qty, countType });
            renderLog();
        }

        function renderLog() {
            const logDiv = document.getElementById('event-log');
            if(sessionLog.length > 0 && document.getElementById('placeholder')) document.getElementById('placeholder').remove();
            
            logDiv.innerHTML = sessionLog.map(e => `
                <div class="log-entry" id="entry-${e.id}">
                    <div class="swipe-container" ontouchstart="handleTouchStart(event, '${e.id}')" ontouchmove="handleTouchMove(event, '${e.id}')">
                        <div class="swipe-content">
                            <span class="w-16 text-slate-400 font-mono text-[10px] shrink-0">${e.time}</span>
                            <span class="flex-1 px-2 uppercase text-center font-bold text-[10px] truncate">${e.action}</span>
                            <span class="w-16 text-right font-bold text-[10px] shrink-0">${e.qty}</span>
                        </div>
                        <div class="delete-btn" onclick="deleteEntry('${e.id}')">Borrar</div>
                    </div>
                </div>`).reverse().join('');
        }

        // --- SWIPE LOGIC (FIXED) ---
        let startX = 0;
        function handleTouchStart(e, id) { startX = e.touches[0].clientX; }
        function handleTouchMove(e, id) {
            let diff = startX - e.touches[0].clientX;
            let container = document.querySelector(`#entry-${id} .swipe-container`);
            if (diff > 50) container.classList.add('swiped');
            if (diff < -50) container.classList.remove('swiped');
        }

        function deleteEntry(id) {
            const idx = sessionLog.findIndex(e => e.id == id);
            if (idx !== -1) {
                const entry = sessionLog[idx];
                if (entry.countType) updateCount(entry.countType, -1);
                sessionLog.splice(idx, 1);
                renderLog();
            }
        }

        function updateCount(k, val) {
            counts[k] += val;
            document.getElementById('count-'+k).innerText = Math.max(0, counts[k]);
        }

        function logAdrenalina() {
            logAction('Adrenalina', '1 mg', 'adr');
            if (!adrActive) {
                adrActive = true;
                document.getElementById('adr-container').classList.remove('hidden');
                document.getElementById('cycle-count-container').classList.add('hidden');
            }
            adrTimeLeft = adrLimitSecs;
        }

        function toggleSelect(btn, action, qty) {
            btn.classList.toggle('selected-item');
            const idx = selectedBuffer.findIndex(i => i.action === action && i.qty === qty);
            idx > -1 ? selectedBuffer.splice(idx, 1) : selectedBuffer.push({ action, qty });
        }

        function confirmMultiple(modalId, contId) {
            selectedBuffer.forEach(i => logAction(i.action, i.qty));
            closeAndClear(modalId, contId);
        }

        function closeAndClear(mId, cId) {
            selectedBuffer = [];
            document.querySelectorAll(`#${cId} button`).forEach(b => b.classList.remove('selected-item'));
            toggleModal(mId);
        }

        // --- TIMERS ---
        function startCPR() {
            if(active) return; active = true;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            timer = setInterval(() => {
                totalSecs++; cycleSecs--;
                if(adrActive) adrTimeLeft--;
                if(cycleSecs <= 0) { showToast("RITME", "red"); cycleSecs = 120; cycles++; document.getElementById('cycle-count').innerText = cycles; document.getElementById('count-cicles').innerText = cycles; logAction(`CICLE ${cycles}`); }
                if(adrActive && adrTimeLeft <= 0) { showToast("ADRENALINA", "orange"); adrTimeLeft = adrLimitSecs; }
                updateUI();
            }, 1000);
        }

        function updateUI() {
            const pad = (n) => n.toString().padStart(2,'0');
            document.getElementById('t-total').innerText = `${pad(Math.floor(totalSecs/3600))}:${pad(Math.floor((totalSecs%3600)/60))}:${pad(totalSecs%60)}`;
            document.getElementById('t-cycle').innerText = `${pad(Math.floor(cycleSecs/60))}:${pad(cycleSecs%60)}`;
            if(adrActive) document.getElementById('t-adr').innerText = `${pad(Math.floor(adrTimeLeft/60))}:${pad(adrTimeLeft%60)}`;
            document.getElementById('cycle-box').className = cycleSecs < 10 ? "p-2 text-center alert-flash" : "p-2 text-center";
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.style.backgroundColor = type === "red" ? "#ef4444" : "#f97316";
            t.style.opacity = "1";
            setTimeout(() => t.style.opacity = "0", 3000);
            playAlarm(type === "red" ? 880 : 660);
        }

        function playAlarm(f) {
            if(!audioCtx) return;
            [0, 0.4, 0.8].forEach(d => {
                setTimeout(() => {
                    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                    o.connect(g); g.connect(audioCtx.destination);
                    o.frequency.value = f; o.type = "square";
                    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.3);
                    o.start(); o.stop(audioCtx.currentTime + 0.3);
                }, d * 1000);
            });
        }

        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); if(id=='history-modal') loadHistory(); }
        function logRitme(r) { logAction('Ritme: ' + r); toggleModal('ritme-modal'); }
        function toggleAdrLimit() { adrLimitSecs = adrLimitSecs == 180 ? 120 : 180; document.getElementById('adr-limit-val').innerText = adrLimitSecs/60; adrTimeLeft = adrLimitSecs; }
        function confirmStop() { if(active) { clearInterval(timer); document.getElementById('stop-modal').classList.remove('hidden'); } }
        function resumeCPR() { startCPR(); toggleModal('stop-modal'); }
        function saveAndReset() { location.reload(); }
        function saveNote() { const v = document.getElementById('note-input').value; if(v) { logAction("NOTA", v); document.getElementById('note-input').value = ""; toggleModal('notes-modal'); } }
        function loadHistory() { /* L√≤gica historial similar a la teva */ }
    </script>
</body>
</html>
