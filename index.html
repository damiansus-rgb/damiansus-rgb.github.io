<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PCR SAMU">
    <link rel="apple-touch-icon" href="https://i.ibb.co/LzNfD4f/samu-icon.png">
    
    <title>PCR EXTRAHOSPITAL√ÄRIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; touch-action: manipulation; -webkit-user-select: none; }
        .btn-press:active { transform: scale(0.95); filter: brightness(0.9); }
        .log-entry { animation: slideIn 0.3s ease-out; border-bottom: 1px solid #f1f5f9; padding: 0.75rem 1rem; background: white; display: flex; justify-content: space-between; align-items: center; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .alert-flash { animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { background-color: #fee2e2; } 50% { background-color: #ef4444; color: white; } }
        .adr-flash { animation: flash-orange 1s infinite; }
        @keyframes flash-orange { 0%, 100% { background-color: #ffedd5; } 50% { background-color: #f97316; color: white; } }
        
        .selected-item { background-color: #64748b !important; color: white !important; border-color: #475569 !important; }
        
        #toast { transition: opacity 0.5s ease; pointer-events: none; z-index: 1000; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col overflow-hidden relative text-slate-800">

    <div id="toast" class="opacity-0 fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-600 text-white px-8 py-4 rounded-3xl shadow-2xl text-center">
        <p id="toast-title" class="text-xs font-bold uppercase mb-1">Atenci√≥</p>
        <p id="toast-msg" class="text-2xl font-black uppercase">Revisar Ritme</p>
    </div>

    <header class="bg-white px-4 pt-12 pb-4 border-b flex justify-between items-center shadow-sm shrink-0">
        <div class="flex items-center gap-2 max-w-[70%]">
            <div class="bg-blue-600 p-1.5 rounded-lg text-white font-bold text-sm shrink-0">SAMU</div>
            <h1 class="text-base font-black tracking-tighter uppercase leading-none">Extrahospital√†ria</h1>
        </div>
        <button onclick="confirmStop()" class="text-white font-bold text-[9px] bg-red-600 px-3 py-2 rounded-full shadow-sm uppercase shrink-0">Finalitzar</button>
    </header>

    <div id="timer-box" class="bg-white grid grid-cols-3 border-b divide-x text-center shrink-0">
        <div class="p-3 text-center">
            <p class="text-[8px] font-bold text-slate-400 uppercase mb-1">Total</p>
            <span id="t-total" class="text-2xl font-mono font-black tracking-tighter">00:00:00</span>
        </div>
        <div id="cycle-box" class="p-3 text-center">
            <p class="text-[8px] font-bold text-slate-400 uppercase mb-1">Ritme en</p>
            <span id="t-cycle" class="text-2xl font-mono font-black text-blue-600 tracking-tighter">02:00</span>
        </div>
        <div class="p-3 flex flex-col justify-center items-center">
            <div id="adr-container" class="hidden text-center cursor-pointer" onclick="toggleAdrLimit()">
                <p class="text-[7px] font-bold text-orange-500 uppercase">Adren (<span id="adr-limit-val">3</span>')</p>
                <span id="t-adr" class="text-lg font-mono font-black text-orange-600">03:00</span>
            </div>
            <div id="cycle-count-container">
                <p class="text-[8px] font-bold text-slate-400 uppercase mb-1">Cicles</p>
                <span id="cycle-count" class="text-2xl font-mono font-black">1</span>
            </div>
        </div>
    </div>

    <div class="bg-slate-50 px-5 py-2 border-b flex justify-between text-[9px] font-bold text-slate-400 uppercase tracking-widest shrink-0">
        <span class="w-16">Temps</span>
        <span class="flex-1 px-2 text-center">Acci√≥</span>
        <span class="w-12 text-right">Esborra</span>
    </div>

    <div id="event-log" class="flex-1 overflow-y-auto bg-white">
        <div id="placeholder" class="text-center py-20 opacity-20 italic text-sm">Inicia l'acci√≥ per comen√ßar</div>
    </div>

    <div class="bg-slate-50 px-5 py-2 border-t border-b flex items-center justify-between shrink-0">
        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Recompte:</span>
        <div class="flex gap-4 text-slate-500 font-bold text-[11px]">
            <span>‚è±Ô∏è <span id="count-cicles">1</span></span>
            <span>‚ö° <span id="count-shock">0</span></span>
            <span>üíâ <span id="count-adr">0</span></span>
            <span>üíä <span id="count-amio">0</span></span>
        </div>
    </div>

    <div class="bg-white p-4 grid grid-cols-2 gap-2 pb-10 shadow-2xl shrink-0">
        <button onclick="toggleModal('ritme-modal')" class="bg-blue-700 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase">Ritmes</button>
        <button onclick="logAdrenalina()" class="bg-blue-700 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase">Adrenalina</button>
        <button onclick="logAction('Desc√†rrega', '200J', 'shock')" class="bg-blue-700 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase">Desc√†rrega</button>
        <button onclick="logAction('Amiodarona', '300 mg', 'amio')" class="bg-blue-700 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase">Amiodarona</button>
        <button onclick="toggleModal('intubacio-modal')" class="bg-blue-100 text-blue-800 p-4 rounded-xl font-bold text-[11px] btn-press uppercase">V√≠a A√®ria</button>
        <button onclick="toggleModal('sri-modal')" class="bg-blue-100 text-blue-800 p-4 rounded-xl font-bold text-[11px] btn-press uppercase">SRI (F√†rmacs)</button>
        <button onclick="toggleModal('ht-modal')" class="bg-slate-100 text-slate-700 p-4 rounded-xl font-bold text-[11px] btn-press uppercase border">H/T Causes</button>
        <button onclick="toggleModal('notes-modal')" class="bg-slate-100 text-slate-700 p-4 rounded-xl font-bold text-[11px] btn-press uppercase border">Notes</button>
        <button onclick="toggleModal('history-modal')" class="bg-slate-800 text-white p-4 rounded-xl font-bold text-[11px] btn-press uppercase col-span-2 text-center shadow-lg">Consultar Historial</button>
    </div>

    <div id="sri-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6 z-[200]">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl overflow-y-auto max-h-[80vh]">
            <h2 class="text-xs font-bold text-slate-800 mb-6 text-center uppercase">F√†rmacs SRI</h2>
            <div class="grid grid-cols-1 gap-2 mb-6" id="sri-options">
                <button onclick="toggleSelect(this, 'Rocuroni', '1.2 mg/kg')" class="bg-slate-50 py-3 rounded-xl text-[11px] font-bold flex justify-between px-4 border"><span>Rocuroni</span> <span>1.2 mg/kg</span></button>
                <button onclick="toggleSelect(this, 'Succinilcolina', '1.5 mg/kg')" class="bg-slate-50 py-3 rounded-xl text-[11px] font-bold flex justify-between px-4 border"><span>Succinilcolina</span> <span>1.5 mg/kg</span></button>
                <button onclick="toggleSelect(this, 'Propofol', '2 mg/kg')" class="bg-slate-50 py-3 rounded-xl text-[11px] font-bold flex justify-between px-4 border"><span>Propofol</span> <span>2 mg/kg</span></button>
                <button onclick="toggleSelect(this, 'Ketamina', '2 mg/kg')" class="bg-slate-50 py-3 rounded-xl text-[11px] font-bold flex justify-between px-4 border"><span>Ketamina</span> <span>2 mg/kg</span></button>
                <button onclick="toggleSelect(this, 'Etomidat', '0.3 mg/kg')" class="bg-slate-50 py-3 rounded-xl text-[11px] font-bold flex justify-between px-4 border"><span>Etomidat</span> <span>0.3 mg/kg</span></button>
                <button onclick="toggleSelect(this, 'Midazolam', '0.3 mg/kg')" class="bg-slate-50 py-3 rounded-xl text-[11px] font-bold flex justify-between px-4 border"><span>Midazolam</span> <span>0.3 mg/kg</span></button>
            </div>
            <button onclick="confirmMultiple('sri-modal', 'sri-options')" class="w-full bg-blue-700 text-white py-4 rounded-full font-bold text-xs uppercase mb-2 shadow-lg">Acceptar</button>
            <button onclick="closeAndClear('sri-modal', 'sri-options')" class="w-full text-slate-400 font-bold text-xs uppercase py-2">Tancar</button>
        </div>
    </div>

    <div id="intubacio-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6 z-[200]">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl overflow-y-auto max-h-[80vh]">
            <h2 class="text-xs font-bold text-slate-800 mb-6 text-center uppercase">V√≠a A√®ria</h2>
            <div id="airway-options">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2 text-center">TUBO ET</p>
                <div class="grid grid-cols-4 gap-2 mb-4" id="tube-btns"></div>
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2 text-center">IGEL</p>
                <div class="grid grid-cols-3 gap-2 mb-6">
                    <button onclick="toggleSelect(this, 'IGEL', '3')" class="bg-slate-50 py-3 rounded-lg text-[11px] font-bold border">3</button>
                    <button onclick="toggleSelect(this, 'IGEL', '4')" class="bg-slate-50 py-3 rounded-lg text-[11px] font-bold border">4</button>
                    <button onclick="toggleSelect(this, 'IGEL', '5')" class="bg-slate-50 py-3 rounded-lg text-[11px] font-bold border">5</button>
                </div>
            </div>
            <button onclick="confirmMultiple('intubacio-modal', 'airway-options')" class="w-full bg-blue-700 text-white py-4 rounded-full font-bold text-xs uppercase mb-2 shadow-lg">Acceptar</button>
            <button onclick="closeAndClear('intubacio-modal', 'airway-options')" class="w-full text-slate-400 font-bold text-xs uppercase py-2">Tancar</button>
        </div>
    </div>

    <div id="ht-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6 z-[200]">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl overflow-y-auto max-h-[80vh]">
            <h2 class="text-xs font-bold text-slate-800 mb-6 text-center uppercase">Causes Reversibles</h2>
            <div class="grid grid-cols-2 gap-2 mb-6" id="ht-options">
                <button onclick="toggleSelect(this, 'Hipovol√®mia', 'SI')" class="bg-slate-50 py-3 rounded-full text-[10px] font-bold border">Hipovol√®mia</button>
                <button onclick="toggleSelect(this, 'Hip√≤xia', 'SI')" class="bg-slate-50 py-3 rounded-full text-[10px] font-bold border">Hip√≤xia</button>
                <button onclick="toggleSelect(this, 'Hipot√®rmia', 'SI')" class="bg-slate-50 py-3 rounded-full text-[10px] font-bold border">Hipot√®rmia</button>
                <button onclick="toggleSelect(this, 'Hidroelectr√≤l.', 'SI')" class="bg-slate-50 py-3 rounded-full text-[10px] font-bold border">Electr√≤lits</button>
                <button onclick="toggleSelect(this, 'Pneumot√≤rax', 'SI')" class="bg-slate-50 py-3 rounded-full text-[10px] font-bold border">Pneumot√≤rax</button>
                <button onclick="toggleSelect(this, 'Taponament', 'SI')" class="bg-slate-50 py-3 rounded-full text-[10px] font-bold border">Taponament</button>
                <button onclick="toggleSelect(this, 'T√≤xics', 'SI')" class="bg-slate-50 py-3 rounded-full text-[10px] font-bold border">T√≤xics</button>
                <button onclick="toggleSelect(this, 'Trombosi', 'SI')" class="bg-slate-50 py-3 rounded-full text-[10px] font-bold border">Trombosi</button>
            </div>
            <button onclick="confirmMultiple('ht-modal', 'ht-options')" class="w-full bg-blue-700 text-white py-4 rounded-full font-bold text-xs uppercase mb-2 shadow-lg">Acceptar</button>
            <button onclick="closeAndClear('ht-modal', 'ht-options')" class="w-full text-slate-400 font-bold text-xs uppercase py-2">Tancar</button>
        </div>
    </div>

    <div id="ritme-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6 z-[200]">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 text-center shadow-2xl">
            <h2 class="text-xs font-bold mb-6 uppercase">Ritme</h2>
            <div class="grid grid-cols-2 gap-2 mb-6">
                <button onclick="logRitme('AESP')" class="bg-slate-500 text-white py-3 rounded-xl font-bold text-[11px]">AESP</button>
                <button onclick="logRitme('Asist√≤lia')" class="bg-slate-500 text-white py-3 rounded-xl font-bold text-[11px]">Asist√≤lia</button>
                <button onclick="logRitme('FV')" class="bg-blue-600 text-white py-3 rounded-xl font-bold text-[11px]">FV</button>
                <button onclick="logRitme('TVsp')" class="bg-blue-600 text-white py-3 rounded-xl font-bold text-[11px]">TVsp</button>
            </div>
            <button onclick="logRitme('ROSC')" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-[11px] mb-4 uppercase">ROSC</button>
            <button onclick="toggleModal('ritme-modal')" class="text-slate-400 font-bold text-xs uppercase">Tancar</button>
        </div>
    </div>

    <div id="history-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6 z-[300]">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 h-[80vh] flex flex-col shadow-2xl">
            <h2 class="text-xs font-bold mb-4 uppercase text-center tracking-widest">Historial SAMU</h2>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-3 mb-4"></div>
            <button onclick="toggleModal('history-modal')" class="w-full bg-blue-700 text-white py-3 rounded-full font-bold text-xs uppercase">Tancar</button>
        </div>
    </div>

    <div id="notes-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6 z-[200]">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h2 class="text-xs font-bold mb-4 uppercase">Escriure Nota</h2>
            <textarea id="note-input" rows="4" class="w-full border p-3 rounded-xl mb-4 text-sm outline-none focus:border-blue-400" placeholder="Escriu la nota aqu√≠..."></textarea>
            <div class="flex gap-2">
                <button onclick="saveNote()" class="flex-1 bg-blue-700 text-white py-3 rounded-full font-bold text-xs uppercase">Guardar</button>
                <button onclick="toggleModal('notes-modal')" class="flex-1 bg-slate-100 py-3 rounded-full font-bold text-xs uppercase text-slate-500">Tancar</button>
            </div>
        </div>
    </div>

    <div id="stop-modal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-6 z-[400]">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 text-center shadow-2xl">
            <h2 class="text-lg font-black uppercase mb-4 text-red-600">Aturar RCP?</h2>
            <button onclick="saveAndReset()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-bold uppercase shadow-lg mb-2">Guardar i Sortir</button>
            <button onclick="toggleModal('stop-modal')" class="w-full bg-slate-100 py-4 rounded-2xl font-bold uppercase tracking-widest text-slate-600">TORNAR</button>
        </div>
    </div>

    <script>
        let totalSecs = 0, cycleSecs = 120, cycles = 1, timer, active = false;
        let adrSecs = 180, adrLimitSecs = 180, adrActive = false;
        let counts = { shock:0, adr:0, amio:0 };
        let sessionLog = [];
        let audioCtx = null;
        let selectedBuffer = [];

        // L√íGICA DE RECOMPTE I REGISTRE
        function logAction(action, qty = '-', countType = null) {
            if(!active) startCPR();
            const time = document.getElementById('t-total').innerText;
            const id = Date.now() + Math.random();
            
            if (countType && countType !== 'adr') {
                counts[countType]++;
                updateStatsUI();
            }
            
            sessionLog.push({ id, time, action, qty, countType });
            renderLog();
        }

        function removeLogEntry(id) {
            const index = sessionLog.findIndex(e => e.id === id);
            if (index > -1) {
                const entry = sessionLog[index];
                if (entry.countType) {
                    counts[entry.countType] = Math.max(0, counts[entry.countType] - 1);
                    updateStatsUI();
                }
                sessionLog.splice(index, 1);
                renderLog();
            }
        }

        function updateStatsUI() {
            document.getElementById('count-shock').innerText = counts.shock;
            document.getElementById('count-adr').innerText = counts.adr;
            document.getElementById('count-amio').innerText = counts.amio;
        }

        function renderLog() {
            const logDiv = document.getElementById('event-log');
            if(sessionLog.length > 0 && document.getElementById('placeholder')) document.getElementById('placeholder').remove();
            
            logDiv.innerHTML = sessionLog.map(e => `
                <div class="log-entry">
                    <span class="w-16 text-slate-400 font-mono text-[10px] shrink-0">${e.time}</span>
                    <span class="flex-1 px-2 uppercase font-bold text-[10px] tracking-tight leading-tight">${e.action}</span>
                    <span class="w-12 text-center font-bold text-[10px] shrink-0">${e.qty}</span>
                    <button onclick="removeLogEntry(${e.id})" class="ml-2 text-slate-300 active:text-red-500 shrink-0">üóëÔ∏è</button>
                </div>`).reverse().join('');
        }

        function saveNote() {
            const val = document.getElementById('note-input').value.trim();
            if(val) {
                logAction(val, "-"); 
                document.getElementById('note-input').value = '';
                toggleModal('notes-modal');
            }
        }

        // CONTROL D'ADRENALINA
        function logAdrenalina() {
            logAction('Adrenalina', '1 mg', 'adr');
            if (!adrActive) {
                adrActive = true;
                document.getElementById('adr-container').classList.remove('hidden');
                document.getElementById('cycle-count-container').classList.add('hidden');
            }
            adrSecs = adrLimitSecs;
        }

        function toggleAdrLimit() {
            adrLimitSecs = (adrLimitSecs === 180) ? 120 : 180;
            document.getElementById('adr-limit-val').innerText = adrLimitSecs / 60;
            adrSecs = adrLimitSecs;
        }

        // TIMERS
        function startCPR() {
            if(active) return; active = true;
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            timer = setInterval(() => {
                totalSecs++; cycleSecs--;
                if(adrActive) adrSecs--;
                if(cycleSecs <= 0) { showToast("REVISAR RITME", "red"); cycleSecs = 120; cycles++; document.getElementById('cycle-count').innerText = cycles; document.getElementById('count-cicles').innerText = cycles; logAction(`CICLE ${cycles} INICIAT`); }
                if(adrActive && adrSecs <= 0) { showToast("ADRENALINA", "orange"); adrSecs = adrLimitSecs; }
                updateUI();
            }, 1000);
        }

        function updateUI() {
            const pad = (n) => n.toString().padStart(2,'0');
            document.getElementById('t-total').innerText = `${pad(Math.floor(totalSecs/3600))}:${pad(Math.floor((totalSecs%3600)/60))}:${pad(totalSecs%60)}`;
            document.getElementById('t-cycle').innerText = `${pad(Math.floor(cycleSecs/60))}:${pad(cycleSecs%60)}`;
            if(adrActive) document.getElementById('t-adr').innerText = `${pad(Math.floor(adrSecs/60))}:${pad(adrSecs%60)}`;
            if(cycleSecs < 10) document.getElementById('cycle-box').classList.add('alert-flash'); else document.getElementById('cycle-box').classList.remove('alert-flash');
            if(adrActive && adrSecs < 10) document.getElementById('adr-container').classList.add('adr-flash'); else document.getElementById('adr-container').classList.remove('adr-flash');
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.style.backgroundColor = type === "red" ? "#ef4444" : "#f97316";
            t.style.opacity = "1";
            setTimeout(() => t.style.opacity = "0", 3500);
            if (audioCtx) {
                const f = type === "red" ? 880 : 1100;
                [0, 0.2, 0.4].forEach(d => { setTimeout(() => playBeep(f, 0.4), d * 1000); });
            }
        }

        function playBeep(f, d) {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.frequency.value = f; o.type = "square";
            g.gain.setValueAtTime(0.2, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d);
            o.start(); o.stop(audioCtx.currentTime + d);
        }

        // MULTI-SELECCI√ì
        function toggleSelect(btn, action, qty) {
            btn.classList.toggle('selected-item');
            const idx = selectedBuffer.findIndex(i => i.action === action && i.qty === qty);
            idx > -1 ? selectedBuffer.splice(idx, 1) : selectedBuffer.push({ action, qty });
        }

        function confirmMultiple(modalId, contId) {
            selectedBuffer.forEach(i => logAction(i.action, i.qty));
            closeAndClear(modalId, contId);
        }

        function closeAndClear(mId, cId) {
            selectedBuffer = [];
            document.querySelectorAll(`#${cId} button`).forEach(b => b.classList.remove('selected-item'));
            toggleModal(mId);
        }

        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); if(id === 'history-modal') loadHistory(); }
        function logRitme(r) { logAction('Ritme: ' + r); toggleModal('ritme-modal'); }
        function confirmStop() { if(active) document.getElementById('stop-modal').classList.remove('hidden'); }

        // HISTORIAL
        function saveAndReset() {
            const session = { id: Date.now(), date: new Date().toLocaleString(), duration: document.getElementById('t-total').innerText, cycles: cycles, log: [...sessionLog], stats: {...counts} };
            let history = JSON.parse(localStorage.getItem('rcp_history') || '[]');
            history.push(session);
            localStorage.setItem('rcp_history', JSON.stringify(history));
            location.reload(); 
        }

        function loadHistory() {
            const h = JSON.parse(localStorage.getItem('rcp_history') || '[]');
            const list = document.getElementById('history-list');
            if (h.length === 0) { list.innerHTML = "<p class='text-center py-10 opacity-30 uppercase text-xs font-bold'>Sense registres</p>"; return; }
            list.innerHTML = h.map(s => `
                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200 text-[10px] shadow-sm mb-3">
                    <div class="flex justify-between items-start mb-2 uppercase">
                        <span class="font-black text-blue-700 pr-4">${s.date}</span>
                        <div class="flex gap-2 shrink-0">
                            <button onclick="editHistoryEntry(${s.id})" class="text-[14px] opacity-70">‚úèÔ∏è</button>
                            <button onclick="deleteHistoryEntry(${s.id})" class="text-[14px] opacity-70">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-1 font-bold text-slate-600 mb-2 border-t pt-2 border-slate-200/50">
                        <span>‚è±Ô∏è Cicles: ${s.cycles}</span> <span>Durada: ${s.duration}</span>
                        <span>‚ö° Shock: ${s.stats.shock}</span> <span>üíâ Adren: ${s.stats.adr}</span> <span>üíä Amio: ${s.stats.amio}</span>
                    </div>
                    <details class="mt-2 text-slate-500 bg-white p-2 rounded-lg border">
                        <summary class="font-bold cursor-pointer uppercase text-[9px] text-blue-600">Detalls</summary>
                        <div class="mt-2 space-y-1 font-mono">${s.log.map(l => `<p class="border-b pb-1"><strong>${l.time}</strong> - ${l.action} ${l.qty !== '-' ? '('+l.qty+')' : ''}</p>`).join('')}</div>
                    </details>
                </div>`).reverse().join('');
        }

        function deleteHistoryEntry(id) { if(confirm("Eliminar permanentment?")) { let h = JSON.parse(localStorage.getItem('rcp_history') || '[]'); h = h.filter(s => s.id !== id); localStorage.setItem('rcp_history', JSON.stringify(h)); loadHistory(); } }
        function editHistoryEntry(id) { let h = JSON.parse(localStorage.getItem('rcp_history') || '[]'); const entry = h.find(s => s.id === id); const newName = prompt("Nou nom:", entry.date); if (newName) { entry.date = newName; localStorage.setItem('rcp_history', JSON.stringify(h)); loadHistory(); } }

        // Tubs ET
        window.onload = function() {
            const tContainer = document.getElementById('tube-btns');
            [5.0, 5.5, 6.0, 6.5, 7.0, 7.5, 8.0, 8.5].forEach(m => {
                const b = document.createElement('button');
                b.className = "bg-slate-50 py-2 rounded-lg text-[10px] font-bold border";
                b.innerText = m; b.onclick = function() { toggleSelect(this, 'Tubo ET', m); };
                tContainer.appendChild(b);
            });
        };
    </script>
</body>
</html>
